<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>Pok칠Klub.cz - OCR promo k칩d</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #f8f9fa;
      margin: 0; padding: 0;
      color: #1e3259;
    }
    .ocr-container {
      background: #fff;
      max-width: 450px;
      margin: 40px auto 30px;
      border-radius: 20px;
      box-shadow: 0 6px 24px rgba(28,38,78,0.15);
      padding: 36px 30px 28px;
      text-align: center;
    }
    .ocr-logo {
      max-width: 120px;
      margin: 0 auto 20px;
      display: block;
    }
    .ocr-container h3 {
      margin-bottom: 18px;
      color: #1e3355;
      font-weight: 700;
      font-size: 1.35em;
    }
    #custom-photo-btn {
      background: #ffca3a;
      color: #171b23;
      border: none;
      border-radius: 20px;
      padding: 14px 28px;
      font-size: 1.1em;
      font-weight: 700;
      margin-bottom: 15px;
      cursor: pointer;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
      transition: background 0.3s ease;
    }
    #custom-photo-btn:hover {
      background: #ffd86b;
    }
    #use-code {
      background: #347bd3;
      color: #fff;
      border: none;
      border-radius: 18px;
      padding: 14px 28px;
      font-size: 1.1em;
      margin-top: 20px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(52,123,211,0.6);
      transition: background 0.3s ease;
      width: 100%;
    }
    #use-code:disabled {
      background: #acb9c6;
      cursor: default;
      box-shadow: none;
    }
    #recognized-text {
      border-radius: 12px;
      margin: 18px 0 0 0;
      width: 100%;
      padding: 14px;
      font-size: 1.1em;
      border: 1px solid #dee2ef;
      background: #f3f7fb;
      color: #1e3259;
      resize: none;
      height: 80px;
      box-sizing: border-box;
      font-weight: 600;
    }
    #error-message {
      color: #cb382e;
      font-size: 1.1em;
      margin-bottom: 15px;
      min-height: 28px;
      font-weight: 700;
      letter-spacing: 0.1px;
    }
    #file-input {
      display: none;
    }
  </style>
</head>
<body>
  <div class="ocr-container">
    <img src="https://drive.google.com/file/d/119aT5N04xJ_pzSaU4QwbziUiFAOO_YH6/view?usp=sharinghttps://drive.google.com/file/d/119aT5N04xJ_pzSaU4QwbziUiFAOO_YH6/view?usp=sharing" alt="Pok칠Klub.cz Logo" class="ocr-logo" />
    <h3>Na캜t캩te sv콢j promo k칩d</h3>
    <div id="error-message"></div>
    <button id="custom-photo-btn" type="button">游닞 Vyfotit promo k칩d</button>
    <input type="file" id="file-input" accept="image/*" capture="environment" />

    <textarea id="recognized-text" placeholder="Zde se zobraz칤 promo k칩d..." readonly></textarea><br />
    <button id="use-code" disabled>Pou쮂셦 k칩d</button>
  </div>

  <script>
    const fileInput = document.getElementById('file-input');
    const customPhotoBtn = document.getElementById('custom-photo-btn');
    const textarea = document.getElementById('recognized-text');
    const useCodeButton = document.getElementById('use-code');
    const errorDiv = document.getElementById('error-message');
    const apiKey = 'K87964261688957'; // V치코 OCR.space API kl칤캜

    customPhotoBtn.addEventListener('click', () => {
      errorDiv.innerText = '';
      fileInput.value = ''; // Reset hodnoty pro opakov치n칤 v칳b캩ru
      fileInput.click();
    });

    function showMessage(msg) {
      errorDiv.innerText = msg ? `Web Pok칠klub.cz 콏칤k치: ${msg}` : '';
    }

    function najdiPromoKody(text) {
      const regex = /\b[A-Z0-9]{10,13}\b/g;
      const matches = text.toUpperCase().match(regex);
      if (!matches) return [];
      return matches.filter(code => /[A-Z]/.test(code) && /\d/.test(code));
    }

    function compressResizeImage(file, maxSizeMB, callback) {
      const maxSizeBytes = maxSizeMB * 1024 * 1024;
      const reader = new FileReader();
      reader.onload = e => {
        const img = new Image();
        img.onload = () => {
          let width = img.width;
          let height = img.height;
          let quality = 0.9;
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');

          function attemptCompress() {
            canvas.width = width;
            canvas.height = height;
            ctx.clearRect(0, 0, width, height);
            ctx.drawImage(img, 0, 0, width, height);
            canvas.toBlob(blob => {
              if (blob.size <= maxSizeBytes || (quality < 0.3 && width < 300)) {
                callback(blob);
              } else {
                quality -= 0.1;
                if (quality < 0.5) {
                  width = Math.floor(width * 0.9);
                  height = Math.floor(height * 0.9);
                  quality = 0.9;
                }
                attemptCompress();
              }
            }, 'image/jpeg', quality);
          }
          attemptCompress();
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    fileInput.addEventListener('change', () => {
      showMessage('');
      if (!fileInput.files.length) {
        textarea.value = '';
        useCodeButton.disabled = true;
        return;
      }
      textarea.value = 'Na캜칤t치m...';
      useCodeButton.disabled = true;

      compressResizeImage(fileInput.files[0], 0.999, resizedBlob => {
        const formData = new FormData();
        formData.append('apikey', apiKey);
        formData.append('language', 'eng');
        formData.append('file', resizedBlob, 'image.jpg');
        formData.append('isOverlayRequired', 'false');

        fetch('https://api.ocr.space/parse/image', { method: 'POST', body: formData })
          .then(response => response.json())
          .then(result => {
            if (result.IsErroredOnProcessing) {
              textarea.value = '';
              showMessage(result.ErrorMessage.join('; ') || 'Chyba p콏i rozpozn치v치n칤. Zkuste to pros칤m znovu.');
              return;
            }
            const text = result.ParsedResults?.[0]?.ParsedText || '';
            const promoKody = najdiPromoKody(text);
            if (promoKody.length > 0) {
              textarea.value = promoKody.join('\n');
              useCodeButton.disabled = false;
              if (promoKody.length === 1) {
                showMessage('Automaticky jste rozpoznali promo k칩d, budete p콏esm캩rov치ni na str치nku pro jeho zad치n칤.');
                setTimeout(() => {
                  showMessage('');
                  const url = `https://store.pokemongo.com/offer-redemption?passcode=${promoKody[0]}`;
                  window.location.href = url;
                }, 1800);
              } else {
                showMessage('');
              }
            } else {
              textarea.value = text;
              showMessage('promo k칩d nebyl automaticky nalezen.');
            }
          })
          .catch(err => {
            textarea.value = '';
            showMessage('Chyba p콏i komunikaci s OCR slu쬭ou: ' + err.message);
          });
      });
    });

    useCodeButton.addEventListener('click', () => {
      let selectedText = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd).trim();
      if (!selectedText) selectedText = textarea.value.trim();
      if (!selectedText) {
        showMessage('Pros칤m, vyberte nebo upravte promo k칩d.');
        return;
      }
      const code = selectedText.replace(/[^A-Z0-9]/gi, '').toUpperCase();
      window.location.href = `https://store.pokemongo.com/offer-redemption?passcode=${code}`;
    });
  </script>
</body>
</html>

